(()=>{var b=window.siteConfig.apiUrl,A={line:["#1f77b4","#d62728","#2ca02c","#9467bd","#ff7f0e","#17becf","#e377c2","#8c564b","#bcbd22","#7f7f7f"]},D={ONE_DAY:24,ONE_WEEK:24*7,TWO_WEEKS:24*14},C={get(){return new URLSearchParams(window.location.search)},update(c){let t=this.get();for(let[e,a]of Object.entries(c))t.set(e,a);history.pushState(null,null,"?"+t.toString()),document.dispatchEvent(new CustomEvent("urlParamsChanged"))}};document.addEventListener("DOMContentLoaded",async()=>{let c=document.querySelectorAll(".chart-container-wrapper");for(let e of c){let a=e.querySelector(".chart-container .chart"),s=a.dataset.chartType||"line";await I.create(s,e,a).initialize()}let t=document.querySelectorAll(".table-container-wrapper");for(let e of t){let a=e.querySelector(".table-container .gridjs-container");await new x(e,a).initialize()}});var I=class{static create(t,e,a){switch(t.toLowerCase()){case"line":return new v(e,a);default:throw new Error(`Unsupported chart type: ${t}`)}}},L=class{constructor(t,e){this.wrapperEl=t,this.chartEl=e,this.dataset=[],this.sources=[],this.timeStart=new Date(this.chartEl.dataset.timeStart),this.timeEnd=new Date(this.chartEl.dataset.timeEnd),this.region=null,this.regionCode=this.chartEl.dataset.region,this.locations={},this.locationCodes=this.chartEl.dataset.locations.split(","),document.addEventListener("urlParamsChanged",()=>this.syncFromURL())}async initialize(){this.syncFromURL(),await this.fetchData(),this.setupUI(),await this.render()}syncFromURL(){let t=C.get(),e=!1;t.has("start")&&(this.chartEl.dataset.timeStart=t.get("start"),this.timeStart=new Date(this.chartEl.dataset.timeStart),e=!0),t.has("end")&&(this.chartEl.dataset.timeEnd=t.get("end"),this.timeEnd=new Date(this.chartEl.dataset.timeEnd),e=!0),t.has("region")&&(this.regionCode=this.chartEl.dataset.region=t.get("region").toUpperCase(),e=!0),t.has("locations")&&(this.chartEl.dataset.locations=t.get("locations").toUpperCase().split(".").join(","),this.locationCodes=this.chartEl.dataset.locations.split(","),e=!0),e&&this.chart&&this.fetchData().then(()=>this.render())}updateURLParams(){C.update({start:this.timeStart.toISOString().split("T")[0],end:this.timeEnd.toISOString().split("T")[0],locations:this.locationCodes.join("."),region:this.regionCode})}async fetchData(){throw new Error("fetchData method must be implemented by subclass")}setupUI(){this.setupLocationSelectors(),this.setupExportButton(),this.setupClearSelectionButton()}setupLocationSelectors(){let t=this.wrapperEl.querySelector(".selected-locations");t.innerHTML="";for(let e of[this.region,...this.region.children]){let a=document.createElement("div");a.className="flex items-center p-3";let s=document.createElement("input");s.type="checkbox",s.id=e.code,s.checked=this.locationCodes.includes(e.code),s.className="location-checkbox mr-3 h-4 w-4",s.addEventListener("change",async()=>await this.updateVisualization());let r=document.createElement("label");r.htmlFor=e.code,r.className="text-sm text-gray-600",r.textContent=e.name,a.appendChild(s),a.appendChild(r),t.appendChild(a)}}setupSourceInfo(){let t=this.wrapperEl.querySelector(".sources");t&&(t.textContent=E.formatSourceList(this.sources))}setupExportButton(){let t=this.wrapperEl.querySelector(".save-chart");t&&t.addEventListener("click",()=>this.export())}setupClearSelectionButton(){let t=this.wrapperEl.querySelector(".clear-selection");t&&t.addEventListener("click",async()=>{this.wrapperEl.querySelectorAll(".location-checkbox").forEach(a=>a.checked=!1),await this.updateVisualization()})}export(){let t=this.wrapperEl.querySelector(".chart-container"),e={pixelRatio:5,backgroundColor:"#fff"};htmlToImage.toBlob(t,e).then(a=>{saveAs(a,`${this.chartEl.dataset.indicator}.png`)}).catch(a=>{console.error("Failed to save image",a)})}getSelectedLocations(){let t=this.wrapperEl.querySelector(".selected-locations");return Array.from(t.querySelectorAll(".location-checkbox:checked")).map(e=>e.id)}async render(){throw new Error("render method must be implemented by subclass")}async updateVisualization(){throw new Error("updateVisualization method must be implemented by subclass")}},v=class extends L{constructor(t,e){super(t,e),this.chart=null,this.indicator=this.chartEl.dataset.indicator}async fetchData(){let t=await g.fetchIndicatorData(this.indicator,this.timeStart,this.timeEnd,this.regionCode);this.dataset=t.dataset,this.sources=t.sources,this.region=t.region,this.locations=t.locations}async render(){this.chart=echarts.init(this.chartEl,null,{renderer:"svg"});let t={series:await this.generateSeries(),grid:{top:10,bottom:0,left:0,right:0,containLabel:!0},xAxis:{data:Array.from({length:this.timeEnd.getFullYear()-this.timeStart.getFullYear()+1},(e,a)=>this.timeStart.getFullYear()+a)},yAxis:{min:e=>{let a=e.max-e.min,s=Math.pow(10,Math.floor(Math.log10(a)));return Math.floor(e.min/s)*s},splitLine:{lineStyle:{type:"dashed"}}},color:A.line,tooltip:{trigger:"axis"},dataZoom:{show:!0,type:"inside",start:0,end:100}};this.chart.setOption(t),window.addEventListener("resize",()=>{this.chart.resize()}),this.setupSourceInfo()}async generateSeries(){return this.locationCodes=this.getSelectedLocations(),this.dataset.filter(e=>this.locationCodes.includes(e.code)).map(e=>({name:e.name,type:"line",data:e.data,showSymbol:!1,endLabel:{show:!0,formatter:"{a}",distance:1,minMargin:2},labelLayout(a){return{align:"right",moveOverlap:"shiftY"}},emphasis:{focus:"series"}}))}async updateVisualization(){let t=await this.generateSeries();this.chart.setOption({series:t},{replaceMerge:["series"]}),this.updateURLParams()}},x=class{constructor(t,e){this.wrapperEl=t,this.tableEl=e,this.sources=[],this.datasetByIndicator={},this.indicators=this.tableEl.dataset.indicators.split(","),this.units=this.tableEl.dataset.units.split(","),this.timeStart=new Date(this.tableEl.dataset.timeStart),this.timeEnd=new Date(this.tableEl.dataset.timeEnd),this.currentYear=Math.min(new Date().getFullYear(),this.timeEnd.getFullYear()),this.yearSelect=document.getElementById("year-select"),this.locations={},this.regionCode=this.tableEl.dataset.region,this.grid=null,document.addEventListener("urlParamsChanged",()=>this.syncFromURL())}async initialize(){this.syncFromURL(),await this.setupYearSelector(),await this.fetchData(),this.initializeGrid(),this.yearSelect.addEventListener("change",()=>{this.currentYear=parseInt(this.yearSelect.value),this.updateGridData()})}syncFromURL(){let t=C.get(),e=!1;t.has("start")&&(this.tableEl.dataset.timeStart=t.get("start"),this.timeStart=new Date(this.tableEl.dataset.timeStart),e=!0),t.has("end")&&(this.timeEnd=this.tableEl.dataset.timeEnd=t.get("end"),this.timeEnd=new Date(this.tableEl.dataset.timeEnd),this.currentYear=Math.min(new Date().getFullYear(),this.timeEnd.getFullYear()),e=!0),t.has("region")&&(this.regionCode=this.tableEl.dataset.region=t.get("region"),e=!0),e&&this.grid&&this.fetchData().then(()=>this.updateGridData())}async setupYearSelector(){this.yearSelect.innerHTML="";let t=this.timeStart.getFullYear(),e=this.timeEnd.getFullYear();for(let a=e;a>=t;a--){let s=document.createElement("option");s.value=a,s.textContent=a,this.yearSelect.appendChild(s)}this.yearSelect.value=this.currentYear}async fetchData(){try{let t=await g.fetchMultiIndicatorData(this.indicators,this.timeStart,this.timeEnd,this.regionCode);this.datasetByIndicator=t.datasetByIndicator,this.sources=t.sources,this.locations=t.locations}catch(t){console.error("Error fetching data for table:",t),this.renderErrorState()}}initializeGrid(){let t=document.createElement("div");t.id="grid-wrapper",this.tableEl.parentNode.replaceChild(t,this.tableEl);let e=[{id:"country",name:"Country / Region"}];this.indicators.forEach((a,s)=>{e.push({id:a,name:`${this.formatColumnName(a)} (${this.units[s]})`,formatter:r=>this.formatValue(r)})}),this.grid=new gridjs.Grid({columns:e,data:this.prepareGridData(),search:!0,sort:!0,className:{table:"min-w-full",th:"uppercase",td:"text-sm"},style:{table:{"white-space":"nowrap"}},language:{search:{placeholder:"Search"}}}).render(t)}prepareGridData(){let t=this.currentYear-this.timeStart.getFullYear(),e=this.datasetByIndicator[this.indicators[0]]||[],a=[],s={};return this.indicators.forEach(r=>{s[r]={},(this.datasetByIndicator[r]||[]).forEach(i=>{s[r][i.code]=i.data})}),e.forEach(r=>{let i={country:r.name};this.indicators.forEach(l=>{let n=s[l][r.code],h=n?n[t]:null;i[l]=h}),a.push(i)}),a}updateGridData(){this.grid&&this.grid.updateConfig({data:this.prepareGridData()}).forceRender()}renderErrorState(){if(this.grid){this.grid.updateConfig({data:[],pagination:!1}).forceRender();let t=this.tableEl.getElementById("grid-wrapper"),e=document.createElement("div");e.className="text-center text-red-500 py-4",e.textContent="Error loading data. Please try again later.",t.appendChild(e)}}formatColumnName(t){return t.split("-").map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" ")}formatValue(t){return t==null?"\u2014":new Intl.NumberFormat().format(t)}},g=class c{static async fetchGeoEntity(t){let e="/geo/"+t,a=d.getFromCache(e);if(a)return a;try{let s=await fetch(b+e);if(s.ok)a=await s.json(),d.saveToCache(e,a,D.TWO_WEEKS);else throw new Error(`API request failed with status ${s.status}`)}catch(s){throw console.error(`Failed to fetch region with ${t}:`,s),s}return a}static async fetchGeoEntities(t){let e={};return await Promise.all(t.map(async a=>{e[a]=await c.fetchGeoEntity(a)})),e}static async fetchIndicatorData(t,e,a,s){let r=await this.fetchMultiIndicatorData([t],e,a,s);return{dataset:r.datasetByIndicator[t],sources:r.sources,region:r.region,geoEntities:r.geoEntities}}static async fetchMultiIndicatorData(t,e,a,s){let r=await this.fetchGeoEntity(s),i=[s,...r.children.map(o=>o.code)],l=[];for(let o=0;o<i.length;o+=50)l.push(i.slice(o,o+50));let n=[],h={};for(let o of t){let p=[];for(let f of l){let m=await this.fetchDataPoints(o,e,a,f);p=[...p,...m.dataset],n=[...n,...m.sources]}p.sort((f,m)=>f.name.localeCompare(m.name)),h[o]=p}let u=this.deduplicateSources(n);return{datasetByIndicator:h,sources:u,region:r,geoEntities:i}}static async fetchDataPoints(t,e,a,s){let r=s.join(","),i=e.toISOString().split("T")[0],l=a.toISOString().split("T")[0],n=`/query?indicator=${t}&start=${i}&end=${l}&geo_codes=${r}`,h=d.getFromCache(n);if(h)return h;try{let u=await c.fetchGeoEntities(s),o=await fetch(b+n);if(!o.ok)throw new Error(`API request failed with status ${o.status}`);let p=await o.json(),f=await this.fetchSourceInfo(p),m=e.getFullYear(),Y=a.getFullYear()-m+1,F={dataset:Object.entries(p).filter(([y,w])=>w.length>0).map(([y,w])=>{let O=Array(Y).fill(null);return w.forEach(R=>{let S=new Date(R.date).getFullYear()-m;S>=0&&S<Y&&(O[S]=R.numeric_value)}),{code:y,name:u[y].name,data:O}}),sources:f,geoEntities:u};return d.saveToCache(n,F,D.ONE_DAY),F}catch(u){throw console.error("Error fetching data:",u),u}}static async fetchSourceInfo(t){let e={};Object.values(t).forEach(r=>{r.forEach(i=>{i.source_id&&(e[i.source_id]=(e[i.source_id]||0)+1)})});let a={},s=Object.keys(e);return await Promise.all(s.map(async r=>{try{let i="/sources/"+r,l=d.getFromCache(i);if(l){a[r]={...l,year:new Date(l.last_updated).getFullYear(),frequency:e[r]};return}let n=await fetch(`${b}/sources/${r}`);if(n.ok){let h=await n.json();a[r]={...h,year:new Date(h.last_updated).getFullYear(),frequency:e[r]},d.saveToCache(i,h,D.ONE_WEEK)}}catch(i){console.error(`Error fetching source info for ${r}:`,i)}})),Object.values(a).sort((r,i)=>i.frequency-r.frequency)}static deduplicateSources(t){let e=new Set;return t.filter(a=>e.has(a.id)?!1:(e.add(a.id),!0))}},d=class{static saveToCache(t,e,a,s=.2){try{a+=E.getRandomInt(s*a);let r={data:e,expiry:Date.now()+a*60*60*1e3};localStorage.setItem(t,JSON.stringify(r))}catch(r){r instanceof DOMException&&(r.code===22||r.code===1014||r.name==="QuotaExceededError"||r.name==="NS_ERROR_DOM_QUOTA_REACHED")&&localStorage.clear()}}static getFromCache(t){let e=localStorage.getItem(t);if(!e)return null;let a=JSON.parse(e);return Date.now()>a.expiry?(localStorage.removeItem(t),null):a.data}},E=class{static formatSourceList(t){if(!t||t.length===0)return"...";t.length>1&&(t=t.filter(a=>a.name!="Derived"));let e=a=>`${a.name} (${a.year})`;return t.length===1?e(t[0]):t.length<=3?t.map(e).join(", "):t.slice(0,3).map(e).join(", ")+", et al."}static getRandomInt(t){return Math.floor(Math.random()*t)}};})();
