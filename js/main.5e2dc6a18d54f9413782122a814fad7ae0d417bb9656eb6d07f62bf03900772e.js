(()=>{var b=window.siteConfig.apiUrl,A={line:["#1f77b4","#d62728","#2ca02c","#9467bd","#ff7f0e","#17becf","#e377c2","#8c564b","#bcbd22","#7f7f7f"]},C={ONE_DAY:24,ONE_WEEK:24*7,TWO_WEEKS:24*14},x={get(){return new URLSearchParams(window.location.search)},update(h){let t=this.get();for(let[e,a]of Object.entries(h))t.set(e,a);history.pushState(null,null,"?"+t.toString()),document.dispatchEvent(new CustomEvent("urlParamsChanged"))}};document.addEventListener("DOMContentLoaded",async()=>{let h=document.querySelectorAll(".chart-container-wrapper");for(let e of h){let a=e.querySelector(".chart-container .chart"),s=a.dataset.chartType||"line";await D.create(s,e,a).initialize()}let t=document.querySelectorAll(".data-table");for(let e of t)await new Y(e).initialize()});var D=class{static create(t,e,a){switch(t.toLowerCase()){case"line":return new I(e,a);default:throw new Error(`Unsupported chart type: ${t}`)}}},L=class{constructor(t,e){this.wrapperEl=t,this.chartEl=e,this.dataset=[],this.sources=[],this.timeStart=new Date(this.chartEl.dataset.timeStart),this.timeEnd=new Date(this.chartEl.dataset.timeEnd),this.region=null,this.regionCode=this.chartEl.dataset.region,this.locations={},this.locationCodes=this.chartEl.dataset.locations.split(","),document.addEventListener("urlParamsChanged",()=>this.syncFromURL())}async initialize(){this.syncFromURL(),await this.fetchData(),await this.setupUI(),await this.render()}syncFromURL(){let t=x.get(),e=!1;t.has("start")&&(this.chartEl.dataset.timeStart=t.get("start"),this.timeStart=new Date(this.chartEl.dataset.timeStart),e=!0),t.has("end")&&(this.chartEl.dataset.timeEnd=t.get("end"),this.timeEnd=new Date(this.chartEl.dataset.timeEnd),e=!0),t.has("region")&&(this.regionCode=this.chartEl.dataset.region=t.get("region").toUpperCase(),e=!0),t.has("locations")&&(this.chartEl.dataset.locations=t.get("locations").toUpperCase().split(".").join(","),this.locationCodes=this.chartEl.dataset.locations.split(","),e=!0),e&&this.chart&&this.fetchData().then(()=>this.render())}updateURLParams(){x.update({start:this.timeStart.toISOString().split("T")[0],end:this.timeEnd.toISOString().split("T")[0],locations:this.locationCodes.join("."),region:this.regionCode})}async fetchData(){throw new Error("fetchData method must be implemented by subclass")}async setupUI(){await this.setupLocationSelectors(),this.setupExportButton()}async setupLocationSelectors(){let t=this.wrapperEl.querySelector(".selected-locations");t.innerHTML="";for(let e of[this.region,...this.region.children]){let a=document.createElement("div");a.className="flex items-center p-3";let s=document.createElement("input");s.type="checkbox",s.id=e.code,s.checked=this.locationCodes.includes(e.code),s.className="mr-3 h-4 w-4",s.addEventListener("change",async()=>await this.updateVisualization());let r=document.createElement("label");r.htmlFor=e.code,r.className="text-sm text-gray-600",r.textContent=e.name,a.appendChild(s),a.appendChild(r),t.appendChild(a)}}setupSourceInfo(){let t=this.wrapperEl.querySelector(".sources");t&&(t.textContent=g.formatSourceList(this.sources))}setupExportButton(){let t=this.wrapperEl.querySelector(".save-chart");t&&t.addEventListener("click",()=>this.export())}export(){let t=this.wrapperEl.querySelector(".chart-container"),e={pixelRatio:5,backgroundColor:"#fff"};htmlToImage.toBlob(t,e).then(a=>{saveAs(a,`${this.chartEl.dataset.indicator}.png`)}).catch(a=>{console.error("Failed to save image",a)})}getSelectedLocations(){let t=this.wrapperEl.querySelector(".selected-locations"),e=Array.from(t.querySelectorAll("input:checked")).map(a=>a.id);return e.length==0?this.locationCodes:e}async render(){throw new Error("render method must be implemented by subclass")}async updateVisualization(){throw new Error("updateVisualization method must be implemented by subclass")}},I=class extends L{constructor(t,e){super(t,e),this.chart=null,this.indicator=this.chartEl.dataset.indicator}async fetchData(){let t=await w.fetchIndicatorData(this.indicator,this.timeStart,this.timeEnd,this.regionCode);this.dataset=t.dataset,this.sources=t.sources,this.region=t.region,this.locations=t.locations}async render(){this.chart=echarts.init(this.chartEl,null,{renderer:"svg"});let t={series:await this.generateSeries(),grid:{top:10,bottom:0,left:0,right:0,containLabel:!0},xAxis:{data:Array.from({length:this.timeEnd.getFullYear()-this.timeStart.getFullYear()+1},(e,a)=>this.timeStart.getFullYear()+a)},yAxis:{min:e=>{let a=e.max-e.min,s=Math.pow(10,Math.floor(Math.log10(a)));return Math.floor(e.min/s)*s},splitLine:{lineStyle:{type:"dashed"}}},color:A.line,tooltip:{trigger:"axis"},dataZoom:{show:!0,type:"inside",start:0,end:100}};this.chart.setOption(t),window.addEventListener("resize",()=>{this.chart.resize()}),this.setupSourceInfo()}async generateSeries(){return this.locationCodes=this.getSelectedLocations(),this.dataset.filter(e=>this.locationCodes.includes(e.code)).map(e=>({name:e.name,type:"line",data:e.data,showSymbol:!1,endLabel:{show:!0,formatter:"{a}",distance:1,minMargin:2},labelLayout(a){return{align:"right",moveOverlap:"shiftY"}},emphasis:{focus:"series"}}))}async updateVisualization(){let t=await this.generateSeries();this.chart.setOption({series:t},{replaceMerge:["series"]}),this.updateURLParams()}},Y=class{constructor(t){this.tableEl=t,this.sources=[],this.datasetByIndicator={},this.indicators=this.tableEl.dataset.indicators.split(","),this.units=this.tableEl.dataset.units.split(","),this.timeStart=new Date(this.tableEl.dataset.timeStart),this.timeEnd=new Date(this.tableEl.dataset.timeEnd),this.currentYear=Math.min(new Date().getFullYear(),this.timeEnd.getFullYear()),this.yearSelect=document.getElementById("year-select"),this.locations={},this.regionCode=this.tableEl.dataset.region,document.addEventListener("urlParamsChanged",()=>this.syncFromURL())}async initialize(){this.syncFromURL(),await this.setupYearSelector(),await this.fetchData(),this.renderTable(),this.yearSelect.addEventListener("change",()=>{this.currentYear=parseInt(this.yearSelect.value),this.renderTable()})}syncFromURL(){let t=x.get(),e=!1;t.has("start")&&(this.tableEl.dataset.timeStart=t.get("start"),this.timeStart=new Date(this.tableEl.dataset.timeStart),e=!0),t.has("end")&&(this.timeEnd=this.tableEl.dataset.timeEnd=t.get("end"),this.timeEnd=new Date(this.tableEl.dataset.timeEnd),this.currentYear=this.timeEnd.getFullYear(),e=!0),t.has("region")&&(this.regionCode=this.tableEl.dataset.region=t.get("region"),e=!0),e&&this.tableEl.querySelector("tbody")&&this.fetchData().then(()=>this.renderTable())}async setupYearSelector(){this.yearSelect.innerHTML="";let t=this.timeStart.getFullYear(),e=this.timeEnd.getFullYear();for(let a=e;a>=t;a--){let s=document.createElement("option");s.value=a,s.textContent=a,this.yearSelect.appendChild(s)}this.yearSelect.value=this.currentYear}async fetchData(){try{let t=await w.fetchMultiIndicatorData(this.indicators,this.timeStart,this.timeEnd,this.regionCode);this.datasetByIndicator=t.datasetByIndicator,this.sources=t.sources,this.locations=t.locations}catch(t){console.error("Error fetching data for table:",t),this.renderErrorState()}}renderTable(){let t=this.tableEl.querySelector("thead tr");t.innerHTML="";let e=document.createElement("th");e.textContent="#",e.className="px-3 py-3 text-left text-xs font-bold text-gray-900 uppercase tracking-wider",t.appendChild(e);let a=document.createElement("th");a.textContent="Country",a.className="px-6 py-3 text-left text-xs font-bold text-gray-900 uppercase tracking-wider",t.appendChild(a),this.indicators.forEach((o,c)=>{let n=document.createElement("th");n.textContent=`${this.formatColumnName(o)} (${this.units[c]})`,n.className="px-6 py-3 text-left text-xs font-bold text-gray-900 uppercase tracking-wider",t.appendChild(n)});let s=this.tableEl.querySelector("tbody");s.innerHTML="";let r=this.currentYear-this.timeStart.getFullYear(),i=this.datasetByIndicator[this.indicators[0]]||[],d={};this.indicators.forEach(o=>{d[o]={},(this.datasetByIndicator[o]||[]).forEach(c=>{d[o][c.code]=c.data})}),i.forEach((o,c)=>{let n=document.createElement("tr");n.className=c%2===0?"bg-white":"bg-gray-50",n.classList.add("hover:bg-gray-100");let u=document.createElement("td");u.textContent=c+1,u.className="px-3 py-4 whitespace-nowrap text-sm font-medium text-gray-900",n.appendChild(u);let m=document.createElement("td");m.textContent=o.name,m.className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900",n.appendChild(m),this.indicators.forEach(p=>{let y=document.createElement("td");y.className="px-6 py-4 whitespace-nowrap text-sm text-gray-900";let E=d[p][o.code],F=E?E[r]:null;y.textContent=this.formatValue(F),n.appendChild(y)}),s.appendChild(n)});let l=document.querySelector(".table-sources");l&&(l.textContent=g.formatSourceList(this.sources))}renderErrorState(){let t=this.tableEl.querySelector("tbody");t.innerHTML="";let e=document.createElement("tr"),a=document.createElement("td");a.colSpan=this.indicators.length+1,a.className="px-6 py-4 text-center text-sm text-red-500",a.textContent="Error loading data. Please try again later.",e.appendChild(a),t.appendChild(e)}formatColumnName(t){return t.split("-").map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" ")}formatValue(t){return t==null?"\u2014":new Intl.NumberFormat().format(t)}},w=class h{static async fetchGeoEntity(t){let e="/geo/"+t,a=f.getFromCache(e);if(a)return a;try{let s=await fetch(b+e);if(s.ok)a=await s.json(),f.saveToCache(e,a,C.TWO_WEEKS);else throw new Error(`API request failed with status ${s.status}`)}catch(s){throw console.error(`Failed to fetch region with ${t}:`,s),s}return a}static async fetchGeoEntities(t){let e={};return await Promise.all(t.map(async a=>{e[a]=await h.fetchGeoEntity(a)})),e}static async fetchIndicatorData(t,e,a,s){let r=await this.fetchMultiIndicatorData([t],e,a,s);return{dataset:r.datasetByIndicator[t],sources:r.sources,region:r.region,geoEntities:r.geoEntities}}static async fetchMultiIndicatorData(t,e,a,s){let r=await this.fetchGeoEntity(s),i=[s,...r.children.map(n=>n.code)],d=[];for(let n=0;n<i.length;n+=50)d.push(i.slice(n,n+50));let l=[],o={};for(let n of t){let u=[];for(let m of d){let p=await this.fetchDataPoints(n,e,a,m);u=[...u,...p.dataset],l=[...l,...p.sources]}u.sort((m,p)=>m.name.localeCompare(p.name)),o[n]=u}let c=this.deduplicateSources(l);return{datasetByIndicator:o,sources:c,region:r,geoEntities:i}}static async fetchDataPoints(t,e,a,s){let r=s.join(","),i=e.toISOString().split("T")[0],d=a.toISOString().split("T")[0],l=`/query?indicator=${t}&start=${i}&end=${d}&geo_codes=${r}`,o=f.getFromCache(l);if(o)return o;try{let c=await h.fetchGeoEntities(s),n=await fetch(b+l);if(!n.ok)throw new Error(`API request failed with status ${n.status}`);let u=await n.json(),m=await this.fetchSourceInfo(u),p=e.getFullYear(),E=a.getFullYear()-p+1,O={dataset:Object.entries(u).map(([v,N])=>{let T=Array(E).fill(null);return N.forEach(q=>{let S=new Date(q.date).getFullYear()-p;S>=0&&S<E&&(T[S]=q.numeric_value)}),{code:v,name:c[v].name,data:T}}),sources:m,geoEntities:c};return f.saveToCache(l,O,C.ONE_DAY),O}catch(c){throw console.error("Error fetching data:",c),c}}static async fetchSourceInfo(t){let e={};Object.values(t).forEach(r=>{r.forEach(i=>{i.source_id&&(e[i.source_id]=(e[i.source_id]||0)+1)})});let a={},s=Object.keys(e);return await Promise.all(s.map(async r=>{try{let i="/sources/"+r,d=f.getFromCache(i);if(d){a[r]={...d,year:new Date(d.last_updated).getFullYear(),frequency:e[r]};return}let l=await fetch(`${b}/sources/${r}`);if(l.ok){let o=await l.json();a[r]={...o,year:new Date(o.last_updated).getFullYear(),frequency:e[r]},f.saveToCache(i,o,C.ONE_WEEK)}}catch(i){console.error(`Error fetching source info for ${r}:`,i)}})),Object.values(a).sort((r,i)=>i.frequency-r.frequency)}static deduplicateSources(t){let e=new Set;return t.filter(a=>e.has(a.id)?!1:(e.add(a.id),!0))}},f=class{static saveToCache(t,e,a,s=.2){try{a+=g.getRandomInt(s*a);let r={data:e,expiry:Date.now()+a*60*60*1e3};localStorage.setItem(t,JSON.stringify(r))}catch(r){r instanceof DOMException&&(r.code===22||r.code===1014||r.name==="QuotaExceededError"||r.name==="NS_ERROR_DOM_QUOTA_REACHED")&&localStorage.clear()}}static getFromCache(t){let e=localStorage.getItem(t);if(!e)return null;let a=JSON.parse(e);return Date.now()>a.expiry?(localStorage.removeItem(t),null):a.data}},g=class{static formatSourceList(t){if(!t||t.length===0)return"...";t.length>1&&(t=t.filter(a=>a.name!="Derived"));let e=a=>`${a.name} (${a.year})`;return t.length===1?e(t[0]):t.length<=3?t.map(e).join(", "):t.slice(0,3).map(e).join(", ")+", et al."}static getRandomInt(t){return Math.floor(Math.random()*t)}};})();
