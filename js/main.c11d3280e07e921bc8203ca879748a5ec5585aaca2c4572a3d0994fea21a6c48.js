(()=>{var S="https://api.causality.africa/v1",O={line:["#1f77b4","#d62728","#2ca02c","#9467bd","#ff7f0e","#17becf","#e377c2","#8c564b","#bcbd22","#7f7f7f"]},b={ONE_DAY:24,ONE_WEEK:24*7,TWO_WEEKS:24*14},x={get(){return new URLSearchParams(window.location.search)},update(u){let t=this.get();for(let[e,a]of Object.entries(u))t.set(e,a);history.pushState(null,null,"?"+t.toString()),document.dispatchEvent(new CustomEvent("urlParamsChanged"))}};document.addEventListener("DOMContentLoaded",async()=>{let u=document.querySelectorAll(".chart-container-wrapper");for(let e of u){let a=e.querySelector(".chart-container .chart"),r=a.dataset.chartType||"line";await L.create(r,e,a).initialize()}let t=document.querySelectorAll(".data-table");for(let e of t)await new F(e).initialize()});var L=class{static create(t,e,a){switch(t.toLowerCase()){case"line":return new I(e,a);default:throw new Error(`Unsupported chart type: ${t}`)}}},D=class{constructor(t,e){this.wrapperEl=t,this.chartEl=e,this.dataset=[],this.sources=[],this.timeStart=new Date(this.chartEl.dataset.timeStart),this.timeEnd=new Date(this.chartEl.dataset.timeEnd),this.region=null,this.regionCode=this.chartEl.dataset.region,this.locations={},this.locationCodes=this.chartEl.dataset.locations.split(","),document.addEventListener("urlParamsChanged",()=>this.syncFromURL())}async initialize(){this.syncFromURL(),await this.fetchData(),await this.setupUI(),await this.render()}syncFromURL(){let t=x.get(),e=!1;t.has("start")&&(this.chartEl.dataset.timeStart=t.get("start"),this.timeStart=new Date(this.chartEl.dataset.timeStart),e=!0),t.has("end")&&(this.chartEl.dataset.timeEnd=t.get("end"),this.timeEnd=new Date(this.chartEl.dataset.timeEnd),e=!0),t.has("region")&&(this.regionCode=this.chartEl.dataset.region=t.get("region"),e=!0),t.has("locations")&&(this.chartEl.dataset.locations=t.get("locations").split(".").join(","),this.locationCodes=this.chartEl.dataset.locations.split(","),e=!0),e&&this.chart&&this.fetchData().then(()=>this.render())}updateURLParams(){x.update({start:this.timeStart.getFullYear(),end:this.timeEnd.getFullYear(),locations:this.locationCodes.join("."),region:this.regionCode})}async fetchData(){throw new Error("fetchData method must be implemented by subclass")}async setupUI(){await this.setupLocationSelectors(),this.setupExportButton()}async setupLocationSelectors(){let t=this.wrapperEl.querySelector(".selected-locations");t.innerHTML="",await Promise.all(this.region.locations.map(async e=>{let a=document.createElement("div");a.className="flex items-center p-3";let s=(await y.fetchLocations([e.location_code]))[e.location_code].name,n=document.createElement("input");n.type="checkbox",n.id=e.location_code,n.checked=this.locationCodes.includes(e.location_code),n.className="mr-3 h-4 w-4",n.addEventListener("change",async()=>await this.updateVisualization());let o=document.createElement("label");o.htmlFor=e.location_code,o.className="text-sm text-gray-600",o.textContent=s,a.appendChild(n),a.appendChild(o),t.appendChild(a)}))}setupSourceInfo(){let t=this.wrapperEl.querySelector(".sources");t&&(t.textContent=w.formatSourceList(this.sources))}setupExportButton(){let t=this.wrapperEl.querySelector(".save-chart");t&&t.addEventListener("click",()=>this.export())}export(){let t=this.wrapperEl.querySelector(".chart-container"),e={pixelRatio:5,backgroundColor:"#fff"};htmlToImage.toBlob(t,e).then(a=>{saveAs(a,`${this.chartEl.dataset.indicator}.png`)}).catch(a=>{console.error("Failed to save image",a)})}getSelectedLocations(){let t=this.wrapperEl.querySelector(".selected-locations"),e=Array.from(t.querySelectorAll("input:checked")).map(a=>a.id);return e.length==0?this.locationCodes:e}async render(){throw new Error("render method must be implemented by subclass")}async updateVisualization(){throw new Error("updateVisualization method must be implemented by subclass")}},I=class extends D{constructor(t,e){super(t,e),this.chart=null,this.indicator=this.chartEl.dataset.indicator}async fetchData(){let t=await y.fetchIndicatorData(this.indicator,this.timeStart,this.timeEnd,this.regionCode);this.dataset=t.dataset,this.sources=t.sources,this.region=t.region,this.locations=t.locations}async render(){this.chart=echarts.init(this.chartEl,null,{renderer:"svg"});let t={series:await this.generateSeries(),grid:{top:10,bottom:0,left:0,right:0,containLabel:!0},xAxis:{data:Array.from({length:this.timeEnd.getFullYear()-this.timeStart.getFullYear()+1},(e,a)=>this.timeStart.getFullYear()+a)},yAxis:{min:e=>{let a=e.max-e.min,r=Math.pow(10,Math.floor(Math.log10(a)));return Math.floor(e.min/r)*r},splitLine:{lineStyle:{type:"dashed"}}},color:O.line,tooltip:{trigger:"axis"},dataZoom:{show:!0,type:"inside",start:0,end:100}};this.chart.setOption(t),window.addEventListener("resize",()=>{this.chart.resize()}),this.setupSourceInfo()}async generateSeries(){return this.locationCodes=this.getSelectedLocations(),this.dataset.filter(e=>this.locationCodes.includes(e.code)).map(e=>({name:e.name,type:"line",data:e.data,showSymbol:!1,endLabel:{show:!0,formatter:"{a}",distance:1,minMargin:2},labelLayout(a){return{align:"right",moveOverlap:"shiftY"}},emphasis:{focus:"series"}}))}async updateVisualization(){let t=await this.generateSeries();this.chart.setOption({series:t},{replaceMerge:["series"]}),this.updateURLParams()}},F=class{constructor(t){this.tableEl=t,this.sources=[],this.datasetByIndicator={},this.indicators=this.tableEl.dataset.indicators.split(","),this.units=this.tableEl.dataset.units.split(","),this.timeStart=new Date(this.tableEl.dataset.timeStart),this.timeEnd=new Date(this.tableEl.dataset.timeEnd),this.currentYear=Math.min(new Date().getFullYear(),this.timeEnd.getFullYear()),this.yearSelect=document.getElementById("year-select"),this.locations={},this.regionCode=this.tableEl.dataset.region,document.addEventListener("urlParamsChanged",()=>this.syncFromURL())}async initialize(){this.syncFromURL(),await this.setupYearSelector(),await this.fetchData(),this.renderTable(),this.yearSelect.addEventListener("change",()=>{this.currentYear=parseInt(this.yearSelect.value),this.renderTable()})}syncFromURL(){let t=x.get(),e=!1;t.has("start")&&(this.tableEl.dataset.timeStart=t.get("start"),this.timeStart=new Date(this.tableEl.dataset.timeStart),e=!0),t.has("end")&&(this.timeEnd=this.tableEl.dataset.timeEnd=t.get("end"),this.timeEnd=new Date(this.tableEl.dataset.timeEnd),this.currentYear=this.timeEnd.getFullYear(),e=!0),t.has("region")&&(this.regionCode=this.tableEl.dataset.region=t.get("region"),e=!0),e&&this.tableEl.querySelector("tbody")&&this.fetchData().then(()=>this.renderTable())}async setupYearSelector(){this.yearSelect.innerHTML="";let t=this.timeStart.getFullYear(),e=this.timeEnd.getFullYear();for(let a=e;a>=t;a--){let r=document.createElement("option");r.value=a,r.textContent=a,this.yearSelect.appendChild(r)}this.yearSelect.value=this.currentYear}async fetchData(){try{let t=await y.fetchMultiIndicatorData(this.indicators,this.timeStart,this.timeEnd,this.regionCode);this.datasetByIndicator=t.datasetByIndicator,this.sources=t.sources,this.locations=t.locations}catch(t){console.error("Error fetching data for table:",t),this.renderErrorState()}}renderTable(){let t=this.tableEl.querySelector("thead tr");t.innerHTML="";let e=document.createElement("th");e.textContent="#",e.className="px-3 py-3 text-left text-xs font-bold text-gray-900 uppercase tracking-wider",t.appendChild(e);let a=document.createElement("th");a.textContent="Country",a.className="px-6 py-3 text-left text-xs font-bold text-gray-900 uppercase tracking-wider",t.appendChild(a),this.indicators.forEach((i,c)=>{let l=document.createElement("th");l.textContent=`${this.formatColumnName(i)} (${this.units[c]})`,l.className="px-6 py-3 text-left text-xs font-bold text-gray-900 uppercase tracking-wider",t.appendChild(l)});let r=this.tableEl.querySelector("tbody");r.innerHTML="";let s=this.currentYear-this.timeStart.getFullYear(),n=this.datasetByIndicator[this.indicators[0]]||[],o={};this.indicators.forEach(i=>{o[i]={},(this.datasetByIndicator[i]||[]).forEach(c=>{o[i][c.code]=c.data})}),n.forEach((i,c)=>{let l=document.createElement("tr");l.className=c%2===0?"bg-white":"bg-gray-50",l.classList.add("hover:bg-gray-100");let E=document.createElement("td");E.textContent=c+1,E.className="px-3 py-4 whitespace-nowrap text-sm font-medium text-gray-900",l.appendChild(E);let h=document.createElement("td");h.textContent=i.name,h.className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900",l.appendChild(h),this.indicators.forEach(g=>{let m=document.createElement("td");m.className="px-6 py-4 whitespace-nowrap text-sm text-gray-900";let p=o[g][i.code],C=p?p[s]:null;m.textContent=this.formatValue(C),l.appendChild(m)}),r.appendChild(l)});let d=document.querySelector(".table-sources");d&&(d.textContent=w.formatSourceList(this.sources))}renderErrorState(){let t=this.tableEl.querySelector("tbody");t.innerHTML="";let e=document.createElement("tr"),a=document.createElement("td");a.colSpan=this.indicators.length+1,a.className="px-6 py-4 text-center text-sm text-red-500",a.textContent="Error loading data. Please try again later.",e.appendChild(a),t.appendChild(e)}formatColumnName(t){return t.split("-").map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" ")}formatValue(t){return t==null?"\u2014":new Intl.NumberFormat().format(t)}},y=class{static async fetchIndicatorData(t,e,a,r){let s=await this.fetchMultiIndicatorData([t],e,a,r);return{dataset:s.datasetByIndicator[t],sources:s.sources,region:s.region,locations:s.locations}}static async fetchMultiIndicatorData(t,e,a,r){let s=await this.fetchRegion(r),n=s.locations.map(h=>h.location_code),o=await this.fetchLocations(n),d=50,i=[];for(let h=0;h<n.length;h+=d)i.push(n.slice(h,h+d));let c=[],l={};for(let h of t){let g=[];for(let m of i){let p=await this.fetchDataPoints(h,e,a,m);g=[...g,...p.dataset],c=[...c,...p.sources]}g.sort((m,p)=>m.name.localeCompare(p.name)),l[h]=g}let E=this.deduplicateSources(c);return{datasetByIndicator:l,sources:E,region:s,locations:o}}static async fetchDataPoints(t,e,a,r){let s=r.join(","),n=e.toISOString().split("T")[0],o=a.toISOString().split("T")[0],d=`/query?indicator=${t}&start=${n}&end=${o}&locations=${s}`,i=f.getFromCache(d);if(i)return i;try{let c=await this.fetchLocations(r),l=await fetch(S+d);if(!l.ok)throw new Error(`API request failed with status ${l.status}`);let E=await l.json(),h=await this.fetchSourceInfo(E),m={dataset:Object.entries(E).map(([p,C])=>({code:p,name:c[p].name,data:C.map(v=>v.numeric_value)})),sources:h,locations:c};return f.saveToCache(d,m,b.ONE_DAY),m}catch(c){throw console.error("Error fetching data:",c),c}}static async fetchLocations(t){let e={};return await Promise.all(t.map(async a=>{let r="/locations/"+a,s=f.getFromCache(r);if(s){e[a]=s;return}try{let n=await fetch(S+r);if(n.ok){let o=await n.json();e[a]=o,f.saveToCache(r,o,b.TWO_WEEKS)}else throw new Error(`API request failed with status ${n.status}`)}catch(n){throw console.error(`Failed to fetch location with ${a}:`,n),n}})),e}static async fetchRegion(t){let e="/regions/"+t,a=f.getFromCache(e);if(a)return a;try{let r=await fetch(S+e);if(r.ok)a=await r.json(),f.saveToCache(e,a,b.TWO_WEEKS);else throw new Error(`API request failed with status ${r.status}`)}catch(r){throw console.error(`Failed to fetch region with ${t}:`,r),r}return a}static async fetchSourceInfo(t){let e={};Object.values(t).forEach(s=>{s.forEach(n=>{n.source_id&&(e[n.source_id]=(e[n.source_id]||0)+1)})});let a={},r=Object.keys(e);return await Promise.all(r.map(async s=>{try{let n="/sources/"+s,o=f.getFromCache(n);if(o){a[s]={...o,year:new Date(o.date).getFullYear(),frequency:e[s]};return}let d=await fetch(`${S}/sources/${s}`);if(d.ok){let i=await d.json();a[s]={...i,year:new Date(i.date).getFullYear(),frequency:e[s]},f.saveToCache(n,i,b.ONE_WEEK)}}catch(n){console.error(`Error fetching source info for ${s}:`,n)}})),Object.values(a).sort((s,n)=>n.frequency-s.frequency)}static deduplicateSources(t){let e=new Set;return t.filter(a=>e.has(a.id)?!1:(e.add(a.id),!0))}},f=class{static saveToCache(t,e,a,r=.2){try{a+=w.getRandomInt(r*a);let s={data:e,expiry:Date.now()+a*60*60*1e3};localStorage.setItem(t,JSON.stringify(s))}catch(s){s instanceof DOMException&&(s.code===22||s.code===1014||s.name==="QuotaExceededError"||s.name==="NS_ERROR_DOM_QUOTA_REACHED")&&localStorage.clear()}}static getFromCache(t){let e=localStorage.getItem(t);if(!e)return null;let a=JSON.parse(e);return Date.now()>a.expiry?(localStorage.removeItem(t),null):a.data}},w=class{static formatSourceList(t){if(!t||t.length===0)return"...";let e=a=>`${a.name} (${a.year})`;return t.length===1?e(t[0]):t.length<=3?t.map(e).join(", "):t.slice(0,3).map(e).join(", ")+", et al."}static getRandomInt(t){return Math.floor(Math.random()*t)}};})();
